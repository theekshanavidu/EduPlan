<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Study Planner</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .fc-event { cursor: pointer; border-radius: 4px; padding: 2px 5px; border: none ! Bird; }
        #calendar { height: 80vh; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">

    <div id="login-page" class="flex flex-col items-center justify-center min-h-screen">
        <div class="bg-white p-8 rounded-2xl shadow-xl text-center max-w-sm w-full">
            <h1 class="text-3xl font-bold text-slate-800 mb-6">Study Planner</h1>
            <p class="text-slate-500 mb-8">ඔබේ වැඩකටයුතු පහසුවෙන් ප්ලෑන් කරන්න ලොග් වන්න.</p>
            <button onclick="login()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-semibold hover:bg-blue-700 transition flex items-center justify-center gap-2">
                Google හරහා ඇතුළු වන්න
            </button>
        </div>
    </div>

    <div id="main-dashboard" class="hidden container mx-auto p-4 lg:p-8">
        <div class="flex flex-col lg:flex-row gap-8">
            
            <div class="w-full lg:w-1/3 bg-white p-6 rounded-2xl shadow-md h-fit">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-semibold">නව වැඩක් එක් කරන්න</h2>
                    <button onclick="logout()" class="text-sm text-red-500 hover:underline">Logout</button>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700">මාතෘකාව / විශය</label>
                        <input type="text" id="taskTitle" placeholder="උදා: Physics Practical" class="w-full mt-1 border border-slate-200 p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-700">දිනය</label>
                        <input type="date" id="taskDate" class="w-full mt-1 border border-slate-200 p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700">පටන් ගන්නා වෙලාව</label>
                            <input type="time" id="startTime" class="w-full mt-1 border border-slate-200 p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700">අවසන් වන වෙලාව</label>
                            <input type="time" id="endTime" class="w-full mt-1 border border-slate-200 p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-700">පාටක් තෝරන්න (Color Code)</label>
                        <input type="color" id="taskColor" class="w-full h-12 mt-1 p-1 border border-slate-200 rounded-lg cursor-pointer" value="#3b82f6">
                    </div>

                    <button onclick="saveTask()" class="w-full bg-slate-900 text-white py-3 rounded-lg font-semibold hover:bg-slate-800 transition shadow-lg">Calendar එකට එක් කරන්න</button>
                </div>
            </div>

            <div class="w-full lg:w-2/3 bg-white p-4 rounded-2xl shadow-md">
                <div id="calendar"></div>
            </div>

        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ඔබේ Firebase Config එක මෙහි ඇත
        const firebaseConfig = {
            apiKey: "AIzaSyALIII2FHy65LTvi4AaC6ulXCd6CCXQ2UM",
            authDomain: "time-planning-4ef59.firebaseapp.com",
            projectId: "time-planning-4ef59",
            storageBucket: "time-planning-4ef59.firebasestorage.app",
            messagingSenderId: "481313041090",
            appId: "1:481313041090:web:1292cbf4e51f71748e695b",
            measurementId: "G-YSQ0MXGREW"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let calendar;

        // Calendar එක සකස් කිරීම
        const calendarEl = document.getElementById('calendar');
        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            eventClick: function(info) {
                if(confirm("මේ වැඩේ මකා දමන්නද?")) {
                    deleteDoc(doc(db, "tasks", info.event.id));
                }
            }
        });
        calendar.render();

        // Auth Logic: User ලොග් වී ඇත්දැයි බැලීම
        onAuthStateChanged(auth, user => {
            if (user) {
                document.getElementById('login-page').classList.add('hidden');
                document.getElementById('main-dashboard').classList.remove('hidden');
                loadTasks(user.uid);
            } else {
                document.getElementById('login-page').classList.remove('hidden');
                document.getElementById('main-dashboard').classList.add('hidden');
            }
        });

        // Login Function
        window.login = () => {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider).catch(err => alert(err.message));
        };

        // Logout Function
        window.logout = () => signOut(auth);

        // Save Task Function
        window.saveTask = async () => {
            const title = document.getElementById('taskTitle').value;
            const date = document.getElementById('taskDate').value;
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            const color = document.getElementById('taskColor').value;

            if(!title || !date || !startTime) return alert("කරුණාකර සියලු විස්තර ලබා දෙන්න.");

            try {
                await addDoc(collection(db, "tasks"), {
                    uid: auth.currentUser.uid,
                    title: title,
                    start: `${date}T${startTime}:00`,
                    end: endTime ? `${date}T${endTime}:00` : `${date}T${startTime}:00`,
                    backgroundColor: color,
                    borderColor: color,
                    allDay: false
                });
                // Form එක Reset කිරීම
                document.getElementById('taskTitle').value = "";
            } catch (e) {
                console.error("Error adding document: ", e);
            }
        };

        // Database එකෙන් දත්ත Calendar එකට ගැනීම
        function loadTasks(uid) {
            const q = query(collection(db, "tasks"), where("uid", "==", uid));
            onSnapshot(q, (snapshot) => {
                const events = [];
                snapshot.forEach(docSnap => {
                    let data = docSnap.data();
                    data.id = docSnap.id; // මකා දැමීමට අවශ්‍ය නිසා ID එක ගන්නවා
                    events.push(data);
                });
                calendar.removeAllEvents();
                calendar.addEventSource(events);
            });
        }
    </script>
</body>
</html>
